# 构建阶段
FROM node:22.5.1-alpine AS build

RUN npm install pnpm -g

WORKDIR /app

COPY . .

# RUN touch ./packages/react-app/.env && \
#     echo "PUBLIC_DEBUG_MODE=true" >> ./packages/react-app/.env

RUN pnpm install && \
    pnpm build

# 发布阶段
FROM nginx:stable-alpine AS dist

RUN mkdir -p /app/html/dify-chat
COPY --from=build /app/packages/react-app/dist/ /app/html/dify-chat/
COPY --from=build /app/example/nginx.conf.example /etc/nginx/nginx.conf

EXPOSE 80

# 健康检查：确保 dify-chat/index.html 可访问
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD curl -f -sS http://localhost/dify-chat/index.html || exit 1
